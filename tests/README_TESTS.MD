# ğŸ§ª Guia de Testes - Neo4j Data Loader

SuÃ­te completa de testes unitÃ¡rios e de integraÃ§Ã£o para o script de carga de dados no Neo4j.

## ğŸ“‹ Ãndice

- [InstalaÃ§Ã£o](#instalaÃ§Ã£o)
- [Estrutura dos Testes](#estrutura-dos-testes)
- [Executando os Testes](#executando-os-testes)
- [Cobertura de Testes](#cobertura-de-testes)
- [Testes Implementados](#testes-implementados)

---

## ğŸ”§ InstalaÃ§Ã£o

### DependÃªncias

```bash
pip install pytest pytest-cov pytest-mock neo4j python-dotenv
```

### Estrutura de Arquivos

```
projeto/
â”œâ”€â”€ load_raw.py              # Script principal
â”œâ”€â”€ test_load_raw.py         # Testes unitÃ¡rios
â”œâ”€â”€ test_integration.py      # Testes de integraÃ§Ã£o
â”œâ”€â”€ conftest.py              # ConfiguraÃ§Ãµes pytest
â”œâ”€â”€ .env                     # VariÃ¡veis de ambiente
â””â”€â”€ README_TESTS.md          # Este arquivo
```

---

## ğŸ—ï¸ Estrutura dos Testes

### 1. **Testes UnitÃ¡rios** (`test_load_raw.py`)

Testes que **nÃ£o requerem Neo4j** rodando:

- âœ… **Parsing/Extraction Logic**: Testa parsing de CSV com delimitador pipe (`|`)
- âœ… **Normalization/Deduping Logic**: Testa lÃ³gica de MERGE e deduplicaÃ§Ã£o
- âœ… **File Processing**: Testa operaÃ§Ãµes de arquivo e contagem de linhas
- âœ… **Environment Validation**: Valida variÃ¡veis de ambiente
- âœ… **Thread Safety**: Testa operaÃ§Ãµes concorrentes
- âœ… **Cypher Query Generation**: Valida queries geradas

### 2. **Testes de IntegraÃ§Ã£o** (`test_integration.py`)

Testes que **requerem Neo4j** rodando:

- âœ… **Load Small Dataset**: Carrega dataset de exemplo no Neo4j (TESTE PRINCIPAL)
- âœ… **Deduplication**: Verifica que dados duplicados sÃ£o atualizados
- âœ… **Null ID Filtering**: Confirma filtro de IDs nulos
- âœ… **Order By + Limit**: Testa ordenaÃ§Ã£o e limite de registros
- âœ… **Metadata Fields**: Verifica campos de metadados (`__file`, `__created_at`, etc.)
- âœ… **Error Handling**: Testa tratamento de erros
- âœ… **Performance**: Testes de carga com 1000+ registros

---

## ğŸš€ Executando os Testes

### Executar TODOS os testes

```bash
pytest -v
```

### Executar APENAS testes unitÃ¡rios (sem Neo4j)

```bash
pytest test_load_raw.py -v
```

### Executar APENAS testes de integraÃ§Ã£o (requer Neo4j)

```bash
pytest test_integration.py -v
```

### Executar com relatÃ³rio de cobertura

```bash
pytest --cov=load_raw --cov-report=html --cov-report=term
```

Abra `htmlcov/index.html` para visualizar o relatÃ³rio detalhado.

### Executar testes especÃ­ficos

```bash
# Por classe
pytest test_load_raw.py::TestParsingAndExtraction -v

# Por mÃ©todo
pytest test_integration.py::TestIntegrationSmallDataset::test_load_small_dataset_into_neo4j -v

# Por palavra-chave
pytest -k "dedup" -v
```

### Executar excluindo testes lentos

```bash
pytest -m "not slow" -v
```

---

## âš™ï¸ ConfiguraÃ§Ã£o para Testes de IntegraÃ§Ã£o

### OpÃ§Ã£o 1: Usar Neo4j existente

Configure as variÃ¡veis no arquivo `.env.test`:

```bash
TEST_NEO4J_URI=bolt://localhost:7687
TEST_NEO4J_USER=neo4j
TEST_NEO4J_PASSWORD=your_password
```

Carregue antes de rodar:

```bash
export $(cat .env.test | xargs)
pytest test_integration.py -v
```

### OpÃ§Ã£o 2: Docker Compose para testes

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  neo4j-test:
    image: neo4j:5.17-enterprise
    environment:
      - NEO4J_AUTH=neo4j/testpassword
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_PLUGINS=["apoc"]
    ports:
      - "7687:7687"
    volumes:
      - ./test_import:/var/lib/neo4j/import
```

Execute:

```bash
docker compose -f docker-compose.test.yml up -d
export TEST_NEO4J_PASSWORD=testpassword
pytest test_integration.py -v
docker compose -f docker-compose.test.yml down
```

---

## ğŸ“Š Cobertura de Testes

### Ãreas Cobertas

| Categoria | Testes | Status |
|-----------|--------|--------|
| **Parsing CSV** | 5 testes | âœ… |
| **NormalizaÃ§Ã£o** | 5 testes | âœ… |
| **DeduplicaÃ§Ã£o** | 3 testes | âœ… |
| **File Processing** | 6 testes | âœ… |
| **Thread Safety** | 2 testes | âœ… |
| **ValidaÃ§Ã£o Env** | 3 testes | âœ… |
| **Cypher Queries** | 5 testes | âœ… |
| **IntegraÃ§Ã£o Neo4j** | 7 testes | âœ… |
| **Error Handling** | 2 testes | âœ… |

**Total: 38+ testes implementados**

---

## ğŸ§ª Testes Implementados

### 1. Parsing e ExtraÃ§Ã£o (`TestParsingAndExtraction`)

```python
âœ… test_csv_parsing_with_pipe_delimiter()
   - Valida parsing de CSV com delimitador |

âœ… test_empty_file_handling()
   - Testa arquivo vazio

âœ… test_file_with_header_only()
   - Testa arquivo sÃ³ com header

âœ… test_null_id_filtering()
   - Verifica filtro WHERE row.id IS NOT NULL

âœ… test_large_file_detection()
   - Testa detecÃ§Ã£o de arquivo >100k linhas

âœ… test_max_lines_limit()
   - Verifica aplicaÃ§Ã£o de MAX_LINES_PER_FILE
```

### 2. NormalizaÃ§Ã£o e DeduplicaÃ§Ã£o (`TestNormalizationAndDeduplication`)

```python
âœ… test_merge_creates_unique_nodes()
   - Valida MERGE para unicidade

âœ… test_on_create_sets_timestamps()
   - Verifica campos __created_at em ON CREATE

âœ… test_on_match_updates_timestamps()
   - Verifica campos __updated_at em ON MATCH

âœ… test_constraint_prevents_duplicates()
   - Testa constraint UNIQUE

âœ… test_data_normalization_preserves_source()
   - Confirma preservaÃ§Ã£o de dados originais
```

### 3. Testes de IntegraÃ§Ã£o (`TestIntegrationSmallDataset`)

```python
âœ… test_load_small_dataset_into_neo4j()
   ğŸ¯ TESTE PRINCIPAL - Carrega 5 registros e valida:
   - Total de registros carregados
   - Dados corretos nos nÃ³s
   - Metadados (__file, __created_at)
   - Constraint aplicada

âœ… test_deduplication_on_reload()
   - Carrega mesmos dados 2x
   - Verifica que nÃ£o hÃ¡ duplicaÃ§Ã£o
   - Valida contador de cargas

âœ… test_null_id_filtering()
   - Carrega arquivo com IDs nulos
   - Confirma que foram filtrados

âœ… test_order_by_desc_limit()
   - Carrega 10 registros com LIMIT 5
   - Verifica ORDER BY DESC

âœ… test_metadata_fields()
   - Valida todos campos de metadados
```

---

## ğŸ“ˆ Exemplo de SaÃ­da

```bash
$ pytest test_integration.py::TestIntegrationSmallDataset::test_load_small_dataset_into_neo4j -v

test_integration.py::TestIntegrationSmallDataset::test_load_small_dataset_into_neo4j PASSED

======================== 1 passed in 2.34s =========================
```

### Com `-s` para ver prints:

```bash
$ pytest test_integration.py::TestIntegrationSmallDataset::test_load_small_dataset_into_neo4j -v -s

...
â±ï¸  Carregados 1000 registros em 3.45s
   Neo4j timeTaken: 2893ms
======================== 1 passed in 3.45s =========================
```

---

## ğŸ¯ Checklist para Teste TÃ©cnico

- [x] **Parsing/extraction logic** - `TestParsingAndExtraction` (6 testes)
- [x] **Normalization/deduping logic** - `TestNormalizationAndDeduplication` (5 testes)
- [x] **Bonus: Integration test** - `test_load_small_dataset_into_neo4j` â­

---

## ğŸ› Troubleshooting

### Problema: "Neo4j nÃ£o disponÃ­vel"

```bash
# Verificar se Neo4j estÃ¡ rodando
docker compose ps

# Ver logs
docker compose logs neo4j

# Testar conexÃ£o
echo "MATCH (n) RETURN count(n);" | cypher-shell -u neo4j -p password
```

### Problema: "APOC procedure not found"

Certifique-se que APOC estÃ¡ instalado:

```yaml
# docker-compose.yml
environment:
  - NEO4J_PLUGINS=["apoc"]
```

### Problema: "Permission denied" ao copiar arquivos

```bash
# Dar permissÃµes ao diretÃ³rio import
chmod 777 ./neo4j/import
```

---

## ğŸ“š Recursos Adicionais

- [Pytest Documentation](https://docs.pytest.org/)
- [Neo4j Python Driver](https://neo4j.com/docs/python-manual/current/)
- [APOC Documentation](https://neo4j.com/labs/apoc/)

---

## ğŸ¤ Contribuindo

Para adicionar novos testes:

1. Testes unitÃ¡rios â†’ `test_load_raw.py`
2. Testes de integraÃ§Ã£o â†’ `test_integration.py`
3. Fixtures compartilhadas â†’ `conftest.py`
4. Execute `pytest --cov` para verificar cobertura

---

**âœ¨ Pronto! Todos os requisitos do teste tÃ©cnico estÃ£o cobertos.**